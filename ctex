#!/bin/sh

compileTeX ()
{
    readonly LOG_FILE=tex.log

    tex_file_name=$1

    platex "$tex_file_name" >$LOG_FILE 2>&1
    readonly exit_status=$?
    if [ -e "$(ls | grep bib)" ]; then
        bibtex "$tex_file_name" >>$LOG_FILE 2>&1
        platex "$tex_file_name" >>$LOG_FILE 2>&1
    fi
    dvipdfmx "$tex_file_name".dvi

    if [ $exit_status -eq 0 ]; then
        open "$tex_file_name".pdf
    else
        cat $LOG_FILE
    fi
}

getMainTex ()
{
    for tex_file in *.tex
    do
        if [ -e "$tex_file" ]; then
            main_tex="$(grep '\\documentclass' "$tex_file")"
            [ -n "$main_tex" ] && echo "$tex_file"; break
        else
            exit
        fi
    done

    echo ""
}

[ -z "$(ls | grep tex)" ] && exit
while [ 1 ]
do
    current="$(pwd)"
    [ "$current" = "/" ] && exit

    compile_file="$(getMainTex)"
    if [ -n "$compile_file" ]; then
        compileTeX "${compile_file%.*}"
        exit
    else
        cd ..
    fi
done
