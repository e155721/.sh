#!/bin/sh

readonly LOG_FILE=tex.log

for tex_file in *.tex
do
    [ -e "$tex_file" ] || exit
    main_tex="$(grep '\\documentclass' "$tex_file")"
    [ -n "$main_tex" ] && break
done

readonly tex_file_name="${tex_file%.*}"

platex "$tex_file_name" >$LOG_FILE 2>&1
readonly exit_status=$?
if [ -e "$(ls | grep bib)" ]; then
    bibtex "$tex_file_name" >>$LOG_FILE 2>&1
    platex "$tex_file_name" >>$LOG_FILE 2>&1
fi
dvipdfmx "$tex_file_name".dvi

if [ $exit_status -eq 0 ]; then
    open "$tex_file_name".pdf
else
    cat $LOG_FILE
fi
