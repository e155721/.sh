#!/bin/sh

readonly LOG_FILE=tex.log

current_path=1
e=1
while [ $e -eq 1 ];
do
    for tex_file in *.tex
    do
        #[ -e "$tex_file" ] || exit
        [ -z "$tex_file" -a "$current_path" -eq 1 ] &&  exit
        current_path=0
        [ -e "$tex_file" ] && main_tex="$(grep '\\documentclass' "$tex_file")"

        if [ -n "$main_tex" ]; then
            e=0
            break
        else
            cd ..
            break
        fi
    done
done

readonly tex_file_name="${tex_file%.*}"

platex "$tex_file_name" >$LOG_FILE 2>&1
readonly exit_status=$?
if [ -e "$(ls | grep bib)" ]; then
    bibtex "$tex_file_name" >>$LOG_FILE 2>&1
    # The "LaTeX Font Warning: Font shape" happen
    # after ">>$LOG_FILE 2>&1" of this line will be comment out
    platex "$tex_file_name" >>$LOG_FILE 2>&1
fi
dvipdfmx "$tex_file_name".dvi

if [ $exit_status -eq 0 ]; then
    open "$tex_file_name".pdf
else
    cat $LOG_FILE
fi
