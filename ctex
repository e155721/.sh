#!/bin/sh

compileTeX ()
{
    readonly LOG_FILE=tex.log

    compile_path=$1
    cd "$compile_path"

    tex_file_name="$(<.tex_root)"
    tex_file_name="${tex_file_name%.*}"

    platex "$tex_file_name" >$LOG_FILE 2>&1
    readonly exit_status=$?
    if [ -e "$(ls | grep bib)" ]; then
        bibtex "$tex_file_name" >>$LOG_FILE 2>&1
        # The "LaTeX Font Warning: Font shape" happen
        # after ">>$LOG_FILE 2>&1" of this line will be comment out
        platex "$tex_file_name" >>$LOG_FILE 2>&1
    fi
    dvipdfmx "$tex_file_name".dvi

    if [ $exit_status -eq 0 ]; then
        open "$tex_file_name".pdf
    else
        cat $LOG_FILE
    fi
}

getMainTex ()
{
    exist_tex_file="$(ls *.tex 2>/dev/zero)"
    [ -z "$exist_tex_file" ] && exit

    for tex_file in *.tex
    do
        if [ -e "$tex_file" ]; then
            main_tex="$(grep '\\documentclass' "$tex_file")"
            [ -n "$main_tex" ] && echo "$tex_file"; break
        else
            exit
        fi
    done

    echo ""
}

current_path="$(pwd)"
compile_path="$(pwd)"
while [ 1 ]
do
    [ "$(pwd)" = "/" ] && break
    if [ -e ".tex_root" ]; then
        compileTeX "$compile_path"
        exit
    else
        cd ..
        compile_path="$(pwd)"
    fi
done

compile_path="$current_path"
cd "$compile_path"
main_tex="$(getMainTex)"
if [ -n "$main_tex" ]; then
    echo "$main_tex" >.tex_root
    compileTeX "$compile_path"
else
    exit
fi
