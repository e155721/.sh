#!/bin/sh

readonly LOG_FILE=tex.log

for tex_file in *.tex
do
    [ -e "$tex_file" ] || exit
    main_tex="$(grep '\\documentclass' "$tex_file")"
    if [ -n "$main_tex" ]; then
        break
    fi
done

tex_file_name="${tex_file%.*}"
if [ "$(ls | grep bib)" ]; then
    platex "$tex_file_name" >$LOG_FILE 2>&1
    exit_status=$?
    bibtex "$tex_file_name" >>$LOG_FILE 2>&1
    platex "$tex_file_name" >>$LOG_FILE 2>&1
    dvipdfmx "$tex_file_name".dvi
    #dvipdfmx "$tex_file_name".dvi >>$LOG_FILE 2>&1
else
    platex "$tex_file_name".tex >$LOG_FILE 2>&1
    exit_status=$?
    dvipdfmx "$tex_file_name".dvi
    #dvipdfmx "$tex_file_name".dvi >>$LOG_FILE 2>&1
fi

if [ $exit_status -eq 0 ]; then
    open "$tex_file_name".pdf
else
    cat $LOG_FILE
fi
