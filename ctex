#!/bin/sh

compileTeX ()
{
    readonly LOG_FILE=tex.log

    while [ 1 ]
    do
        [ -e ".tex_root" ] && break
        cd ..
    done

    for tex_file in *.tex
    do
        [ -e "$tex_file" ] && main_tex="$(grep '\\documentclass' "$tex_file")"
    done

    readonly tex_file_name="${tex_file%.*}"

    platex "$tex_file_name" >$LOG_FILE 2>&1
    readonly exit_status=$?
    if [ -e "$(ls | grep bib)" ]; then
        bibtex "$tex_file_name" >>$LOG_FILE 2>&1
        # The "LaTeX Font Warning: Font shape" happen
        # after ">>$LOG_FILE 2>&1" of this line will be comment out
        platex "$tex_file_name" >>$LOG_FILE 2>&1
    fi
    dvipdfmx "$tex_file_name".dvi

    if [ $exit_status -eq 0 ]; then
        open "$tex_file_name".pdf
    else
        cat $LOG_FILE
    fi
}

current_path="$(pwd)"
while [ 1 ]
do
    [ "$(pwd)" = "/" ] && break
    if [ -e ".tex_root" ]; then
        compileTeX
    else
        cd ..
    fi
done

cd "$current_path"
exist_tex_file="$(ls *.tex)"
if [ -z "exist_tex_file" ]; then
    touch ".tex_root"
    compileTeX
else
    exit
fi
